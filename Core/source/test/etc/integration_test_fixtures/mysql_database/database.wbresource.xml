<?xml version="1.0"?>
<resource type="MySqlDatabase" id="0d39b8fb-5b5c-48cd-845c-9c4d55f94303" name="MV AAA Database">

	<states>

		<state id="199b7cc1-3cc6-48ca-b012-a70d05d5b5e7" label="Database Created">
			<assertions>
				<assertion type="MySqlDatabaseExists" id="19b64fb6-f95f-4221-bc64-303f62a3eda8" name="Database exists">
					<databaseName>MV.AAA</databaseName>
				</assertion>
			</assertions>
		</state>

		<state id="363568f1-aaed-4a50-bea0-9ddee713cc11" label="Core Schema Loaded">
			<assertions>
				<assertion type="MySqlTableExists" id="3808ba63-f055-4bf7-88fe-023546e6ed16" name="RealmTypeRef exists">
					<tableName>RealmTypeRef</tableName>
				</assertion>
				<assertion type="MySqlTableExists" id="54c78eca-9eda-4983-b9a5-0dcb1be686ff" name="Realm exists">
					<tableName>Realm</tableName>
				</assertion>
			</assertions>
		</state>

		<state id="61ee5deb-aee7-4508-9d9c-1e749e2f7fab" label="UserBase Schema Loaded">
		</state>

	</states>

	<transitions>

		<transition
			type="MySqlCreateDatabase"
			id="6b21e1e3-ff3a-44b3-84ec-e21fb01c0110"
			toStateId="199b7cc1-3cc6-48ca-b012-a70d05d5b5e7">
		</transition>

		<transition
			type="SqlScript"
			id="8b57f16d-c690-4f10-b68f-6f1ee75fe32b"
			fromStateId="199b7cc1-3cc6-48ca-b012-a70d05d5b5e7"
			toStateId="363568f1-aaed-4a50-bea0-9ddee713cc11">
			<sql><![CDATA[

/* RealmTypeRef */
CREATE TABLE  `RealmTypeRef` (
  `RealmTypeRcd` char(2) NOT NULL,
  `Name` varchar(10) NOT NULL,
  PRIMARY KEY (`RealmTypeRcd`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO
    RealmTypeRef(RealmTypeRcd, Name)
VALUES
    ('UB', 'UserBase'),
    ('LD', 'LDAP');

/* RealmStatusRef */
CREATE TABLE  `RealmStatusRef` (
  `RealmStatusRcd` char(1) NOT NULL,
  `Name` varchar(10) NOT NULL,
  PRIMARY KEY (`RealmStatusRcd`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO
	RealmStatusRef(RealmStatusRcd, Name)
VALUES
	('A', 'Active'),
	('I', 'Inactive');

/* Realm */
CREATE TABLE  `Realm` (
  `RealmId` char(36) NOT NULL,
  `Revision` int(10) unsigned NOT NULL,
  `RealmUniqueId` varchar(50) NOT NULL,
  `RealmTypeRcd` char(2) NOT NULL,
  `RealmStatusRcd` char(1) NOT NULL,
  `Name` varchar(50) NOT NULL,
  `Description` varchar(4000) NOT NULL,
  PRIMARY KEY (`RealmId`),
  KEY `FK_Realm_RealmTypeRcd` (`RealmTypeRcd`),
  KEY `FK_Realm_RealmStatusRcd` (`RealmStatusRcd`),
  CONSTRAINT `FK_Realm_RealmStatusRcd` FOREIGN KEY (`RealmStatusRcd`) REFERENCES `RealmStatusRef` (`RealmStatusRcd`),
  CONSTRAINT `FK_Realm_RealmTypeRcd` FOREIGN KEY (`RealmTypeRcd`) REFERENCES `RealmTypeRef` (`RealmTypeRcd`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

/* UserAccountStatusRef */
CREATE TABLE  `UserAccountStatusRef` (
  `UserAccountStatusRcd` char(1) NOT NULL,
  `Name` varchar(10) NOT NULL,
  PRIMARY KEY (`UserAccountStatusRcd`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO
	UserAccountStatusRef(UserAccountStatusRcd, Name)
VALUES
	('A', 'Active'),
	('I', 'Inactive'),
	('L', 'Locked Out');

/* UserAccount */
CREATE TABLE  `UserAccount` (
  `UserAccountId` char(36) NOT NULL,
  `Revision` int(10) unsigned NOT NULL,
  `UserAccountStatusRcd` char(1) NOT NULL,
  `RealmId` char(36) NOT NULL,
  `FailedAuthenticationAttempts` int(10) unsigned NOT NULL,
  PRIMARY KEY (`UserAccountId`),
  KEY `FK_UserAccount_UserAccountStatusRcd` (`UserAccountStatusRcd`),
  KEY `FK_UserAccount_RealmId` (`RealmId`),
  CONSTRAINT `FK_UserAccount_RealmId` FOREIGN KEY (`RealmId`) REFERENCES `Realm` (`RealmId`),
  CONSTRAINT `FK_UserAccount_UserAccountStatusRcd` FOREIGN KEY (`UserAccountStatusRcd`) REFERENCES `UserAccountStatusRef` (`UserAccountStatusRcd`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

/* AuthAuditResultRef */
CREATE TABLE  `AuthAuditResultRef` (
  `AuthAuditResultRcd` char(1) NOT NULL,
  `Name` varchar(30) NOT NULL,
  PRIMARY KEY (`AuthAuditResultRcd`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO
    AuthAuditResultRef(AuthAuditResultRcd, Name)
VALUES
    ('S', 'Success'),
    ('F', 'Authentication Failed'),
    ('N', 'Not Permitted for Realm');

/* AuthAudit */
CREATE TABLE  `AuthAudit` (
  `AuthAuditId` CHAR(36) NOT NULL,
  `UserAccountId` CHAR(36) NOT NULL,
  `TimepointSrvUtc` bigint(20) unsigned NOT NULL,
  `AuthAuditResultRcd` char(1) NOT NULL,
  PRIMARY KEY (`AuthAuditId`),
  KEY `FK_AuthAudit_AuthAuditResultRcd` (`AuthAuditResultRcd`),
  KEY `FK_AuthAudit_UserAccountId` (`UserAccountId`),
  CONSTRAINT `FK_AuthAudit_UserAccountId` FOREIGN KEY (`UserAccountId`) REFERENCES `UserAccount` (`UserAccountId`),
  CONSTRAINT `FK_AuthAudit_AuthAuditResultRcd` FOREIGN KEY (`AuthAuditResultRcd`) REFERENCES `AuthAuditResultRef` (`AuthAuditResultRcd`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

			]]></sql>
		</transition>

		<transition
			type="SqlScript"
			id="8b57f16d-c690-4f10-b68f-6f1ee75fe32b"
			fromStateId="363568f1-aaed-4a50-bea0-9ddee713cc11"
			toStateId="199b7cc1-3cc6-48ca-b012-a70d05d5b5e7">
			<sql><![CDATA[

DROP TABLE AuthAudit;
DROP TABLE AuthAuditResultRef;

DROP TABLE UserAccount;
DROP TABLE UserAccountStatusRef;

DROP TABLE Realm;
DROP TABLE RealmTypeRef;
DROP Table RealmStatusRef;

			]]></sql>
		</transition>
		
		<transition
			type="SqlScript"
			id="8b57f16d-c690-4f10-b68f-6f1ee75fe32b"
			fromStateId="363568f1-aaed-4a50-bea0-9ddee713cc11"
			toStateId="61ee5deb-aee7-4508-9d9c-1e749e2f7fab">
			<sql><![CDATA[

/* UserBaseRealm */
CREATE TABLE  `UserBaseRealm` (
  `RealmId` CHAR(36) NOT NULL,
  PRIMARY KEY (`RealmId`),
  CONSTRAINT `FK_UserBaseRealm_RealmId` FOREIGN KEY (`RealmId`) REFERENCES `Realm` (`RealmId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

/* UserBaseUserAccount */
CREATE TABLE  `UserBaseUserAccount` (
  `UserAccountId` CHAR(36) NOT NULL,
  `RealmId` CHAR(36) NOT NULL,
  `Username` varchar(50) NOT NULL,
  `PasswordSalt` varchar(50) NOT NULL,
  `PasswordHash` varchar(200) NOT NULL,
  PRIMARY KEY (`UserAccountId`),
  KEY `FK_UserBaseUser_RealmId` (`RealmId`),
  CONSTRAINT `FK_UserBaseUserAccount_RealmId` FOREIGN KEY (`RealmId`) REFERENCES `UserBaseRealm` (`RealmId`),
  CONSTRAINT `FK_UserBaseUserAccount_UserAccountId` FOREIGN KEY (`UserAccountId`) REFERENCES `UserAccount` (`UserAccountId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

			]]></sql>
		</transition>

	</transitions>

</resource>
